{{define "title"}} UIS Autograder {{end}}
{{define "body"}}

  <div class="container">
    <div class="row">

      <h1>{{.Org.Name}}</h1>
      <p>From your repository there will be triggered a build each time you push new code up. This code will be tested agains what the teacher is expecting the solution to be. Check out how far you have gotten below.</p>

      <div role="tabpanel">

        <!-- Nav tabs -->
        <ul class="nav nav-tabs" role="tablist" id="labtypetab">
          <li role="presentation"><a href="#students" aria-controls="students" role="tab" data-toggle="tab">Individual</a></li>
          {{if gt .Org.GroupAssignments 0}}<li role="presentation"><a href="#groups" aria-controls="groups" role="tab" data-toggle="tab">Group</a></li>{{end}}
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
          <div role="tabpanel" class="tab-pane" id="students">
            
            <div role="tabpanel">

              <!-- Nav tabs -->
              <ul class="nav nav-tabs" role="tablist" id="indvlabtab">
                {{range $index, $element := .Org.IndividualLabFolders}}
                <li role="presentation"><a href="#{{$element}}" aria-controls="{{$element}}" role="tab" data-toggle="tab">{{$element}}</a></li>
                {{end}}
              </ul>

              <!-- Tab panes -->
              <div class="tab-content">
              {{$course := .Org.Name}}
              {{$Username := .Member.Username}}
              {{range $index, $element := .Org.IndividualLabFolders}}
                <div role="tabpanel" class="tab-pane" id="{{$element}}">
                  <div class="row">
                    <div class="col-lg-8">
                      <h3>Latest build</h3>
                      <p id="status">Status: No build yet</p>
                      <p id="passes">Number of passed tests: 0</p>
                      <p id="timedate">Build time: Not yet</p>
                    </div>
                    <div class="col-lg-4">
                      <h3>Actions</h3>
                      <div class="row">
                        <div class="col-lg-12">
                          <form action="/event/manualbuild" method="get" class="rebuild">
                            <input type="hidden" name="course" value="{{$course}}">
                            <input type="hidden" name="user" value="{{$Username}}">
                            <input type="hidden" name="lab" value="{{$element}}">

                            <button type="submit" class="btn btn-primary">Rebuild code</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="alert alert-success" role="alert" style="display: none"></div>
                  <div class="well">            
                    <code id="logs">
                
                    </code>
                  </div>
                </div>
                {{end}}
              </div>
            </div>

          </div>

          {{if gt .Org.GroupAssignments 0}}
          <div role="tabpanel" class="tab-pane" id="groups">
          {{if.Group}}
            {{if .Group.Active}}
            <div role="tabpanel">

              <!-- Nav tabs -->
              <ul class="nav nav-tabs" role="tablist" id="grouplabtab">
                {{range $index, $element := .Org.GroupLabFolders}}
                <li role="presentation"><a href="#{{$element}}" aria-controls="{{$element}}" role="tab" data-toggle="tab">{{$element}}</a></li>
                {{end}}
              </ul>

              <!-- Tab panes -->
              <div class="tab-content">
                {{$groupid := .Group.ID}}
                {{range $index, $element := .Org.GroupLabFolders}}
                <div role="tabpanel" class="tab-pane" id="{{$element}}">

                  <div class="row">
                    <div class="col-lg-8">
                      <h3>Latest build</h3>
                      <p id="status">Status: No build yet</p>
                      <p id="passes">Number of passed tests: 0</p>
                      <p id="timedate">Build time: Not yet</p>
                    </div>
                    <div class="col-lg-4">
                      <h3>Actions</h3>
                      <div class="row">
                        <div class="col-lg-12">
                          <form action="/event/manualbuild" method="get" class="rebuild">
                            <input type="hidden" name="course" value="{{$course}}">
                            <input type="hidden" name="user" value="group{{$groupid}}">
                            <input type="hidden" name="lab" value="{{$element}}">

                            <button type="submit" class="btn btn-primary">Rebuild code</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="alert alert-success" role="alert" style="display: none"></div>
                  <div class="well">            
                    <code id="logs">
                
                    </code>
                  </div>

                </div>
                {{end}}
              </div>
            </div>
            {{else}}
            <h3>Group pending</h3>
            <p>You are a member of group {{.Group.ID}}. The teacher or a teaching assistant need to approve your group. </p>
            <p>Group members:</p>
            <ol>
              {{range $index, $element := .Group.Members}}
              <li>{{$index}}</li>
              {{end}}
            </ol>
            {{end}}
          {{else}}
            <h3>Group registation</h3>
            <p></p>
            <div class="row">
              <div class="col-lg-4 col-lg-offset-1 text-center">
                <p>If you do not have any preferences of who you are on group select this option. </p>
                <button type="button" class="btn btn-primary" id="random">Random group</button>
              </div>
              <div class="col-lg-4 col-lg-offset-2 text-center">
                <p>Select the members of your group below and submit them. </p>
                <button type="button" class="btn btn-primary" id="groupsubmit">Submit new group</button>
              </div>
            </div>

            <form action="/course/newgroup" method="post" accept-charset="utf-8" id="groupselection">
              <input type="hidden" name="course" value="{{.Org.Name}}">
              <input type="hidden" name="member" value="{{.Member.Username}}">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Selection</th>
                    <th>Username</th>
                  </tr>
                </thead>
                <tbody>
                  {{range $index, $element := .Org.Members}}
                  <tr id="{{$index}}">
                    <td><input type="checkbox" name="member" value="{{$index}}"></td>
                    <td>{{$index}}</td>
                  </tr>
                  {{end}}
                </tbody>
              </table>
            </form>
          {{end}}
          </div>
          {{end}}
        </div>

      </div>

    </div>
  </div>

  <script type="text/javascript">
    var course = "{{.Org.Name}}";
    var username = "{{.Member.Username}}";
    var loadLabResult = function(user, lab){
      $.getJSON("/course/ciresutls", {"Labname": lab, "Course": course, "Username": user}, function(data){
        $("div#" + lab + " > div.well > code#logs").text("");
        $("div#" + lab + " > div > div > p#status").text("Status: ").append(data.Status);
        $("div#" + lab + " > div > div > p#passes").text("Number of passed tests: ").append(data.NumPasses);
        data.Log.forEach(function(t) {
          $("div#" + lab + " > div.well > code#logs").append(" # ").append($(document.createTextNode(t))).append("<br>");
        });
        var d = new Date(data.Timestamp)
        $("div#" + lab + " > div > div > p#timedate").text("Build time: ").append(d.toLocaleDateString() + " - " + d.toLocaleTimeString());
      }).fail(function(){
        $("div#" + lab + " > div.well > code#logs").text("# There is no build for this lab yet.");
      });
    }

    $("form.rebuild").submit(function(event){
      var lab = $(this).children("input[name='lab']").val();
      var user = $(this).children("input[name='user']").val();
      $("div#" + lab + " > div.alert").show(200);
      $("div#" + lab + " > div.alert").removeClass("alert-primary alert-danger alert-success").addClass("alert-warning").text("Running build");
      $.post("/event/manualbuild", $(this).serialize(), function(){
        $("div#" + lab + " > div.alert").removeClass("alert-warning").addClass("alert-success").text("Successfull rebuild. Build log updated.");
        loadLabResult(user, lab)
      }).fail(function(){
        $("div#" + lab + " > div.alert").removeClass("alert-warning").addClass("alert-danger").text("Rebuild failure");
      });
      event.preventDefault();
      return false
    });

    $(function(){
      $('#indvlabtab > li > a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        var lab = e.target.innerHTML
        loadLabResult(username, lab)
      });
    });

    $(function(){
      $('#labtypetab a:first').tab('show');
      $('#indvlabtab a:eq({{.Labnum}})').tab('show');
    });

    {{if.Group}}
    var groupname = "group{{.Group.ID}}";
    $(function(){
      $('#grouplabtab > li > a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        var lab = e.target.innerHTML
        loadLabResult(groupname, lab)
      });
    });

    $(function(){
      $('#grouplabtab a:eq({{.GroupLabnum}})').tab('show');
    });

    {{else}}

    $("button#groupsubmit").click(function(){
      $("form#groupselection").submit();
    });
    $("button#random").click(function(){
      $.post("/course/requestrandomgroup", {"course": {{.Org.Name}}}, function(){
        alert("You have been added to the list over people who wants random groups assignment.")
      });
    });

    {{end}}
  </script>
{{end}}